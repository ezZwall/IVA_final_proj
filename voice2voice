import speech_recognition as sr
import pyttsx3
from transformers import pipeline
import time

# === Initialization ===

engine = pyttsx3.init()
voices = engine.getProperty('voices')
engine.setProperty('voice', voices[0].id)

recognizer = sr.Recognizer()
summarizer = pipeline("summarization", model="facebook/bart-large-cnn")

conversation_history = []
minimum_turns = 3
call_ended = False

# === Small Talk Responses & Intent Keywords ===

small_talk_map = {
    "hi": "Hi there!",
    "hello": "Hello! How can I help you today?",
    "hey": "Hey! What can I do for you?",
    "how are you": "I'm doing great, thanks for asking! How about you?",
    "i'm good": "That's great to hear!",
    "i'm fine": "Glad you're doing well!",
    "not bad": "That's good to hear. What can I help you with today?",
    "what's your name": "I'm your virtual assistant.",
    "who are you": "I'm your assistant, here to help you with anything you need.",
    "thank you": "You're very welcome!",
    "thanks": "Glad to help!",
    "goodbye": "Goodbye! Have a great day!",
    "bye": "Talk to you later!",
    "what do you do": "I'm here to help with things like billing, tech support, appointments, and warranty questions.",
    "are you real": "Iâ€™m real enough to help you get things done!",
    "can you help me": "Of course! What do you need help with?",
    "that's awesome": "Thanks! I'm here to assist.",
}


intent_keywords = {
    "billing": [
        "bill", "payment", "charge", "refund", "invoice", "tax", 
        "pay my bill", "got charged", "billing issue", "overcharged", "how much do I owe"
    ],
    "tech_support": [
        "error", "issue", "problem", "help", "support", "overheating", "computer", "slow",
        "broken", "not working", "crashing", "lag", "blue screen", "freeze", "tech issue"
    ],
    "scheduling": [
        "appointment", "schedule", "reschedule", "meeting", "time", "book", 
        "calendar", "set something up", "plan a call", "make an appointment"
    ],
    "warranty": [
        "warranty", "car", "extended", "vehicle", "coverage", "plan", 
        "insurance", "repair", "warranty details", "fix my car"
    ],
}


intent_responses = {
    "billing": "I can help you with your bill. Would you like to review your charges or make a payment?",
    "tech_support": (
        "It seems you're having a technical issue. Can you describe exactly what's happening? "
        "Is this a desktop or laptop? Has this happened before?"
    ),
    "scheduling": (
        "You want to schedule an appointment. Do you prefer mornings or afternoons? "
        "And which day works best for you?"
    ),
    "warranty": (
        "You're asking about your car's extended warranty. Are you looking to renew it or check your current coverage?"
    ),
    "general_inquiry": "I'm not sure how to help with that. Could you tell me a bit more?",
}


# === Central Conversation Handler ===

def process_user_input(user_input):
    global call_ended, conversation_history

    if call_ended:
        return

    text = user_input.lower()
    if any(trigger in text for trigger in ["bitch", "fuck", "cunt"]):
        engine.say("Call back when you are nicer")
        call_ended = True
        return

    # 1. Handle small talk
    for phrase, response in small_talk_map.items():
        if phrase in text:
            print(f"Assistant: {response}")
            engine.say(response)
            engine.runAndWait()
            return

    # 2. Handle summary/exit/transfer command
    if any(trigger in text for trigger in ["summary", "transfer", "exit"]):
        summarize_and_end()
        return

    
    
    # 3. Add to conversation
    conversation_history.append(user_input)

    # 4. Detect intent
    detected_intent = "general_inquiry"
    for intent, keywords in intent_keywords.items():
        if any(word in text for word in keywords):
            detected_intent = intent
            break

    # 5. Respond to intent
    response = intent_responses.get(detected_intent, intent_responses["general_inquiry"])
    print(f"Assistant: {response}")
    engine.say(response)
    engine.runAndWait()

    # 6. Ask for more info if needed
    if len(conversation_history) < minimum_turns and detected_intent == "general_inquiry":
        followup = "Can you tell me a bit more so I can help you better?"
        print(f"Assistant: {followup}")
        engine.say(followup)
        engine.runAndWait()
    elif len(conversation_history) >= minimum_turns and detected_intent != "general_inquiry":
        summarize_and_end()

# === Summary & End Call ===

def summarize_and_end():
    global call_ended, conversation_history

    full_text = " ".join(conversation_history)
    detected_intent = "general_inquiry"
    for intent, keywords in intent_keywords.items():
        if any(word in full_text.lower() for word in keywords):
            detected_intent = intent
            break

    try:
        if len(full_text.split()) < 25:
            summary = f"I understand you're asking about {detected_intent.replace('_', ' ')}. Here's what you said: {full_text}"
        else:
            relevant_text = full_text
            if 'overheating' in full_text.lower():
                relevant_text = " ".join([line for line in conversation_history if 'overheating' in line.lower()])
            max_len = min(100, int(len(relevant_text.split()) * 0.7))
            summary = summarizer(relevant_text, max_length=max_len, min_length=10, do_sample=False)[0]['summary_text']
            summary = f"You seem to need help with {detected_intent.replace('_', ' ')}. Here's a quick summary: {summary}"

        print(f"Assistant: {summary}")
        engine.say(summary)
        engine.say("Transferring you now.")
        engine.say("Goodbye! Your request is being forwarded. Thank you for calling.")
        engine.runAndWait()

        call_ended = True
        conversation_history.clear()
        time.sleep(2)

    except Exception as e:
        print(f"Error during summarization: {e}")
        engine.say("Sorry, I had trouble summarizing your request.")
        engine.runAndWait()

# === Microphone Listening Loop ===

def listen_for_input():
    with sr.Microphone() as source:
        print("Listening...")
        recognizer.adjust_for_ambient_noise(source)
        recognizer.pause_threshold = 1.5

        try:
            audio = recognizer.listen(source, timeout=10, phrase_time_limit=20)
            user_input = recognizer.recognize_google(audio)
            print(f"You said: {user_input}")
            process_user_input(user_input)

        except sr.UnknownValueError:
            print("Sorry, I didn't catch that.")
        except sr.WaitTimeoutError:
            print("Listening timed out â€” no speech detected.")
        except sr.RequestError:
            print("Speech service error.")
        except Exception as e:
            print(f"An error occurred: {e}")

# === Main Loop ===

if __name__ == "__main__":
    print("ðŸ¤– Assistant Ready. Say 'summary', 'transfer', or 'exit' to end the conversation.")
    while True:
        if not call_ended:
            listen_for_input()
            time.sleep(1)
        else:
            break
